name: Generate WeChat RSS

on:
  schedule:
    # 每天 UTC 3 点执行（约等于北京时间 11 点）
    - cron: '0 3 * * *'
  workflow_dispatch:  # 支持手动触发

permissions:
  contents: write   # 允许工作流提交代码到仓库

jobs:
  build:
    runs-on: ubuntu-latest

    # 从 GitHub Secrets 注入微信 Cookie
    env:
      WECHAT_COOKIE: ${{ secrets.WECHAT_COOKIE }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create docs/feeds directory
        run: |
          mkdir -p docs/feeds

      - name: Start RSSHub with Docker
        run: |
          docker run -d --name rsshub -p 1200:1200 \
            -e NODE_ENV=production \
            -e WECHAT_COOKIE="${WECHAT_COOKIE}" \
            diygod/rsshub:chromium-bundled
          # 等 RSSHub 启动完成
          sleep 20

      - name: Fetch WeChat feeds
        run: |
          set -e
          if [ ! -f wechat_feeds.txt ]; then
            echo "ERROR: wechat_feeds.txt not found in repo root."
            exit 1
          fi

          while IFS=',' read -r slug bizid; do
            # 跳过空行或注释行
            if [ -z "$slug" ] || [[ "$slug" =~ ^# ]]; then
              continue
            fi

            echo "Fetching $slug ($bizid)..."
            curl -sS "http://127.0.0.1:1200/wechat/mp/$bizid" \
              -o "docs/feeds/${slug}.xml"

            if [ ! -s "docs/feeds/${slug}.xml" ]; then
              echo "WARNING: docs/feeds/${slug}.xml is empty!"
            fi
          done < wechat_feeds.txt

      - name: Stop RSSHub
        if: always()
        run: |
          docker rm -f rsshub || true

      - name: Generate OPML
        run: |
          set -e
          REPO_NAME=$(basename "$GITHUB_REPOSITORY")
          BASE_URL="https://${GITHUB_REPOSITORY_OWNER}.github.io/${REPO_NAME}"
          OPML_FILE="docs/wechat.opml"

          echo "Generating OPML at $OPML_FILE"

          {
            echo '<?xml version="1.0" encoding="UTF-8"?>'
            echo '<opml version="2.0">'
            echo '  <head>'
            echo '    <title>WeChat Subscriptions</title>'
            echo "    <dateCreated>$(date -u +'%Y-%m-%dT%H:%M:%SZ')</dateCreated>"
            echo '  </head>'
            echo '  <body>'
            while IFS=',' read -r slug bizid; do
              if [ -z "$slug" ] || [[ "$slug" =~ ^# ]]; then
                continue
              fi
              FEED_URL="${BASE_URL}/feeds/${slug}.xml"
              echo "    <outline text=\"${slug}\" title=\"${slug}\" type=\"rss\" xmlUrl=\"${FEED_URL}\" />"
            done < wechat_feeds.txt
            echo '  </body>'
            echo '</opml>'
          } > "$OPML_FILE"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update WeChat RSS feeds $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "Nothing to commit"
            git pus