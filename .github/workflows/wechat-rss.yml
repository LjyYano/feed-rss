name: Generate WeChat RSS

on:
  schedule:
    - cron: '0 3 * * *'   # 每天 UTC 3 点
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      WECHAT_COOKIE: ${{ secrets.WECHAT_COOKIE }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show wechat_feeds.txt for debug
        run: |
          echo "==== wechat_feeds.txt ===="
          cat wechat_feeds.txt || echo "wechat_feeds.txt not found"

      - name: Create docs/feeds directory
        run: |
          mkdir -p docs/feeds

      - name: Start RSSHub with Docker
        run: |
          docker run -d --name rsshub -p 1200:1200 \
            -e NODE_ENV=production \
            -e WECHAT_COOKIE="${WECHAT_COOKIE}" \
            diygod/rsshub:chromium-bundled
          sleep 20

      - name: Fetch WeChat feeds
        run: |
          set -e
          if [ ! -f wechat_feeds.txt ]; then
            echo "ERROR: wechat_feeds.txt not found in repo root."
            exit 1
          fi

          echo "==== Start fetching feeds ===="
          while IFS=',' read -r slug bizid; do
            # 去掉前后空白
            slug="$(echo "$slug" | xargs)"
            bizid="$(echo "$bizid" | xargs)"

            if [ -z "$slug" ] || [[ "$slug" =~ ^# ]]; then
              continue
            fi

            echo "Fetching slug='$slug' bizid='$bizid' ..."
            curl -sS "http://127.0.0.1:1200/wechat/mp/homepage/$bizid/4" \
              -o "docs/feeds/${slug}.xml"

            if [ ! -s "docs/feeds/${slug}.xml" ]; then
              echo "WARNING: docs/feeds/${slug}.xml is empty!"
            fi
          done < wechat_feeds.txt

          echo "==== files in docs/feeds ===="
          ls -l docs/feeds || echo "no files"

      - name: Stop RSSHub
        if: always()
        run: |
          docker rm -f rsshub || true

      - name: Generate OPML
        run: |
          set -e
          REPO_NAME=$(basename "$GITHUB_REPOSITORY")
          BASE_URL="https://${GITHUB_REPOSITORY_OWNER}.github.io/${REPO_NAME}"
          OPML_FILE="docs/wechat.opml"

          echo "Generating OPML at $OPML_FILE"

          {
            echo '<?xml version="1.0" encoding="UTF-8"?>'
            echo '<opml version="2.0">'
            echo '  <head>'
            echo '    <title>WeChat Subscriptions</title>'
            echo "    <dateCreated>$(date -u +'%Y-%m-%dT%H:%M:%SZ')</dateCreated>"
            echo '  </head>'
            echo '  <body>'

            while IFS=',' read -r slug bizid; do
              slug="$(echo "$slug" | xargs)"
              bizid="$(echo "$bizid" | xargs)"

              if [ -z "$slug" ] || [[ "$slug" =~ ^# ]]; then
                continue
              fi

              FEED_URL="${BASE_URL}/feeds/${slug}.xml"
              echo "    <outline text=\"${slug}\" title=\"${slug}\" type=\"rss\" xmlUrl=\"${FEED_URL}\" />"
            done < wechat_feeds.txt

            echo '  </body>'
            echo '</opml>'
          } > "$OPML_FILE"

          echo "==== wechat.opml generated ===="
          cat "$OPML_FILE"

      - name: Commit and push changes
        run: |
          set -e

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update WeChat RSS feeds" || echo "Nothing to commit"
          git push